name: Deploy Database Changes

on:
  workflow_run:
    workflows: ["Build Database Artifact"]
    types:
      - completed

jobs:
  deploy-dev:
    name: Deploy to Development
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download migration scripts artifact
        uses: actions/download-artifact@v4
        with:
          name: db-deployment-package
          path: migrations

      - name: Install SqlServer PowerShell Module
        shell: pwsh
        run: Install-Module -Name SqlServer -Force -AcceptLicense

      - name: Deploy to Development Database
        shell: pwsh
        run: ./scripts/deploy.ps1 -ConnectionString "${{ secrets.DEV_DB_CONNECTION_STRING }}" -MigrationsPath "./migrations"

  # deploy-prod:
  #   name: Deploy to Production
  #   needs: deploy-dev # Only run if dev deployment succeeds
  #   runs-on: ubuntu-latest
  #   environment: production # This environment must be configured with required reviewers
  #   # Prevent multiple concurrent deployments to production
  #   concurrency:
  #     group: production-migrations
  #     cancel-in-progress: true
  #   # Wait up to 3 days for an approval
  #   timeout-minutes: 4320
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Download migration scripts artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: db-migrations
  #         path: migrations

  #     - name: Install SqlServer PowerShell Module
  #       shell: pwsh
  #       run: Install-Module -Name SqlServer -Force -AcceptLicense

  #     - name: Deploy to Production Database
  #       shell: pwsh

  #       run: ./scripts/deploy.ps1 -ConnectionString "${{ secrets.PROD_DB_CONNECTION_STRING }}" -MigrationsPath "./migrations"